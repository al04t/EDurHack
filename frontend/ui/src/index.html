<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>The Chucking Dillema </title>
    
    <link rel="stylesheet" href="../style/style.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-heatmap/leaflet-heatmap.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-heatmap@1.0.0/leaflet-heatmap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
	<div class="sections">
		<section class="hero">
			<h1>How Much wood can a WoodChuck chuck if a Wood Chuck could chuck wood?</h1>
		</section>

		<section id="dis_map">
                <img id="logo" style="width: 50px;height: 50px;" src="../Assets/image.png" alt="Woodchuck Logo" />
                <div id="mapSection">
                    <img id="logo" style="width: 50px;height: 50px;" src="../Assets/image.png" alt="Woodchuck Logo" />
                    <div id="mapContainer">
                        
                        <div id="map"></div>
                        <div id="gradient" style="color:#5A4634;writing-mode: vertical-rl;text-orientation: sideways; display: flex; justify-content: center; align-items: center;">Chuck Strength</div>
                    </div>
                    <div id="sliderContainer">
                    <p style="color: #F9F8EA;">Value: <span id="value"></span></p>
                        <input type="range" min="2018" max="2528" value="2018" class="slider" id="yearSlider">
             
                         <img id="logo" style="width: 50px;height: 50px; " src="../Assets/image.png" alt="Woodchuck Logo" />
                    </div>
                </div>
                <img id="logo" style="width: 50px;height: 50px;transform: rotate(90deg);transform-origin: center;" src="../Assets/image.png" alt="Woodchuck Logo" />
		</section>

		<section id="dashboard">
			<div class="dashboard">
				<button id="dataButton">Chuck graph</button>
				<div id="dashboardCoordControls" style="display:flex;justify-content:center;gap:12px;align-items:center;margin:8px 0;flex-wrap:wrap;">
					<label for="dashLat" class="dashboard-label">Lat</label>
					<input id="dashLat" class="dash-input" type="number" step="0.0001" placeholder="40.0" title="Press Enter to center, Esc to clear">
					<label for="dashLon" class="dashboard-label">Lon</label>
					<input id="dashLon" class="dash-input" type="number" step="0.0001" placeholder="-76.7" title="Press Enter to center, Esc to clear">
					<div style="flex-basis:100%;height:0;"></div>
				</div>
				<div id="wood_chucking_at" class="chart">
					<canvas id="XYchart"></canvas>
				</div>
			</div>
		</section>

		<section id="mayTheChuckBe">
			<button class="may-control" id="startFall">Start Rain</button>
			<button class="may-control" id="stopFall" style="right:6rem;">Stop</button>
			<div id="fallArea" aria-hidden="true"></div>
			<div id="pileRoot" aria-hidden="true"></div>
		</section>
	</div>

    <script src="../src/script.js"></script>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kJT3vGkT1Q6jT+gQbm0gq3k6k6bS+1n6v5Yyo=" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
	const map = L.map('map', {center:[40.0,-76.7],zoom:8,scrollWheelZoom:false});
		const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

		const markers = L.layerGroup().addTo(map);

		function randMarkers(){
			markers.clearLayers();
			for(let i=0;i<120;i++){
				const lat = 39 + Math.random()*2.5;
				const lon = -80 + Math.random()*4.5;
				const est = Math.round(Math.random()*10000)/10;
				const m = L.circleMarker([lat,lon],{radius:6,fillColor:'#1e90ff',color:'#083058',weight:1,fillOpacity:0.85}).bindPopup(`lat:${lat.toFixed(2)} lon:${lon.toFixed(2)}<br>est: ${est}`);
				markers.addLayer(m);
			}
		}
		randMarkers();

	setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} },50);
	window.addEventListener('load', ()=>{ try{ map.invalidateSize(); }catch(e){} });
	window.addEventListener('resize', ()=>{ try{ map.invalidateSize(); }catch(e){} });
		document.getElementById('btn-zoompa').addEventListener('click',()=>map.setView([40.0,-76.7],8));
		document.getElementById('btn-default').addEventListener('click',()=>{tiles.addTo(map);randMarkers();toggleActive('btn-default')});
		document.getElementById('btn-heat').addEventListener('click',()=>{tiles.addTo(map);randMarkers();toggleActive('btn-heat')});
		function toggleActive(id){document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active')}

	</script>

		<script>
		(function(){
			const area = document.getElementById('mayTheChuckBe');
			const fallArea = document.getElementById('fallArea');
			const pileRoot = document.getElementById('pileRoot');
			const startBtn = document.getElementById('startFall');
			const stopBtn = document.getElementById('stopFall');
			if(!area || !fallArea || !pileRoot) return;

			area.style.position = 'relative';

			function createLegend(){
				let existing = document.getElementById('pileLegend');
				if(existing) return;
				existing = document.createElement('div');
				existing.id = 'pileLegend';
				existing.className = 'pile-legend';
				existing.innerHTML = `<img src="../Assets/pngwing.com.png" alt="log" class="legend-icon"> 1 log = 10 Tones`;
				area.appendChild(existing);
			}

			function scatterDecoration(count=12){
				document.querySelectorAll('.decor-img').forEach(n=>n.remove());
				const areaRectW = Math.max(200, area.clientWidth);
				const areaRectH = Math.max(200, area.clientHeight);
				for(let i=0;i<count;i++){
					const d = document.createElement('img');
					d.src = '../Assets/image.png';
					d.className = 'decor-img';
					d.style.width = (24 + Math.round(Math.random()*24)) + 'px';
					d.style.left = Math.round(Math.random()*(areaRectW-40)) + 'px';
					d.style.top = Math.round(Math.random()*(areaRectH-120)) + 'px';
					d.style.transform = `rotate(${Math.round(Math.random()*360)}deg)`;
					area.appendChild(d);
				}
			}

			createLegend();
			scatterDecoration(12);
			let intervalId = null;
			const IMG = '../Assets/pngwing.com.png';
			const IMG_SIZE = 64;

			const PILE_COUNT = 3;
			const piles = [];
			const areaW = area.clientWidth;
			const spread = Math.max(IMG_SIZE * 4, Math.min(areaW * 0.7, areaW - IMG_SIZE * 4));
			for(let p=0;p<PILE_COUNT;p++){
				const frac = (PILE_COUNT===1) ? 0.5 : (p / (PILE_COUNT-1));
				const centerX = Math.round(-spread/2 + frac * spread);
				const el = document.createElement('div');
				el.className = 'pile-column';
				el.style.position = 'absolute';
				el.style.left = centerX + 'px';
				el.style.bottom = '0px';
				el.style.width = '0px';
				el.style.height = '0px';
				pileRoot.appendChild(el);
				const MAX_ROWS = Math.min(12, Math.max(3, Math.floor(areaW / IMG_SIZE)));
				const rowsTop = Array.from({length: MAX_ROWS}, (_,i)=>i+1);
				const filledCounts = new Array(MAX_ROWS).fill(0);
				piles.push({el, centerX, rowsTop, filledCounts});
			}

			function ensureRowsFor(pile, indexTotal){
				let capacity = pile.rowsTop.reduce((s,v)=>s+v,0);
				while(indexTotal > capacity){
					const next = pile.rowsTop.length + 1;
					pile.rowsTop.push(next);
					pile.filledCounts.push(0);
					capacity += next;
				}
			}

			function findSlotForNewInPile(pile){
				for(let r=0;r<pile.rowsTop.length;r++){
					if(pile.filledCounts[r] < pile.rowsTop[r]){
						const pos = pile.filledCounts[r];
						pile.filledCounts[r] = pile.filledCounts[r] + 1;
						return {row:r, pos: pos};
					}
				}
				const next = pile.rowsTop.length + 1;
				pile.rowsTop.push(next);
				pile.filledCounts.push(1);
				return {row: pile.rowsTop.length-1, pos: 0};
			}

			function slotToXY(pile, row, pos, size){
				const totalRows = pile.rowsTop.length;
				const count = pile.rowsTop[row];
				const bottom = (totalRows - 1 - row) * (size * 0.75);
				const totalWidth = count * size;
				const startX = - totalWidth/2 + (size/2);
				const x = pile.centerX + (startX + pos * size);
				return {x, bottom};
			}

			function dropOne(){
				const img = document.createElement('img');
				img.src = IMG;
				img.className = 'falling-img';
				img.style.width = IMG_SIZE + 'px';
				img.style.height = IMG_SIZE + 'px';
				const containerW = area.clientWidth;
				const centerX = Math.round(containerW/2 - IMG_SIZE/2);
				const startLeft = centerX + (Math.random()*120 - 60);
				img.style.left = startLeft + 'px';
				img.style.top = '-80px';
				fallArea.appendChild(img);

				const pileIndex = Math.floor(Math.random() * piles.length);
				const pile = piles[pileIndex];
				ensureRowsFor(pile, pile.el.children.length + 1);
				const reservedSlot = findSlotForNewInPile(pile);
				const finalBottom = slotToXY(pile, reservedSlot.row, reservedSlot.pos, IMG_SIZE).bottom;
				const targetTop = area.clientHeight - IMG_SIZE - finalBottom; 
				const translateY = targetTop - (-80); 

				const duration = 120 + Math.random()*120;

				const anim = img.animate([
					{ transform: 'translateY(0) rotate(0deg)', opacity:1 },
					{ transform: `translateY(${translateY}px) rotate(${10 + Math.random()*40}deg)`, opacity:1 }
				], { duration: duration, easing: 'cubic-bezier(.2,.9,.2,1)' });

				anim.onfinish = ()=>{
					try{ fallArea.removeChild(img); }catch(e){}
					img.className = 'pile-item';
					img.style.top = 'auto';
					img.style.right = 'auto';
					pile.el.appendChild(img);
					const row = reservedSlot.row;
					const pos = reservedSlot.pos;
					const s = slotToXY(pile, row, pos, IMG_SIZE);
					const leftRel = s.x - pile.centerX;
					img.style.left = leftRel + 'px';
					img.style.bottom = s.bottom + 'px';
					img.dataset.fixed = '1';
					img.dataset.row = String(row);
					img.dataset.pos = String(pos);
					img.dataset.pile = String(pileIndex);
				};
			}

			startBtn.addEventListener('click', async ()=>{
				if(intervalId) return;

				let total = 0;
				try{
					const yearParam = (typeof initialYear !== 'undefined') ? initialYear : Number(document.getElementById('yearSlider').value);
					total = await sumYears(yearParam, true);
					console.log('sumYears result:', total);
				}catch(e){
					console.warn('sumYears unavailable or failed, falling back to single drop', e);
				}
				let target = Math.max(1, Math.floor((total || 0) / 10000));
				console.log('Starting rain — total wood:', total, 'dropping logs:', target);

				let dropped = 0;

				function showResult(count){
					let existing = document.getElementById('dropResult');
					if(!existing){
						existing = document.createElement('div');
						existing.id = 'dropResult';
						existing.className = 'drop-result';
						area.appendChild(existing);
					}
					existing.textContent = `${count}0 Tones will be chucked by 2518`;
					existing.classList.add('show');
	
				}
				dropOne(); dropped += 1;
				if(dropped >= target){
					showResult(target);
					return;
				}
				intervalId = setInterval(()=>{
					dropOne(); dropped += 1;
					if(dropped>=target){
						clearInterval(intervalId);
						intervalId = null;
						showResult(target);
					}
				}, 20);

				

			});

			stopBtn.addEventListener('click', ()=>{
				if(intervalId) clearInterval(intervalId);
				intervalId = null;
			});

			function layoutPyramid(root, size){
				for(const pile of piles){
					const items = Array.from(pile.el.children);
					if(items.length === 0) continue;
					pile.filledCounts = new Array(pile.rowsTop.length).fill(0);
					for(const it of items){
						if(it.dataset && it.dataset.row){
							const r = parseInt(it.dataset.row,10);
							if(!Number.isNaN(r)) pile.filledCounts[r] = (pile.filledCounts[r] || 0) + 1;
						}
					}
					for(const it of items){
						if(it.dataset && it.dataset.fixed === '1') continue;
						ensureRowsFor(pile, items.length);
						const slot = findSlotForNewInPile(pile);
						const s = slotToXY(pile, slot.row, slot.pos, size);
						const leftRel = s.x - pile.centerX;
						it.style.left = leftRel + 'px';
						it.style.bottom = s.bottom + 'px';
						it.dataset.fixed = '1';
						it.dataset.row = String(slot.row);
						it.dataset.pos = String(slot.pos);
						it.dataset.pile = String(piles.indexOf(pile));
						pile.filledCounts[slot.row] = (pile.filledCounts[slot.row] || 0) + 1;
					}
				}
			}
		})();
		</script>
</body>
</html>

